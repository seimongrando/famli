# ==============================================================================
# Famli - Docker Compose
# ==============================================================================
# Configuração para rodar o Famli em containers.
#
# Uso:
#   docker-compose up -d       # Iniciar em background
#   docker-compose logs -f     # Ver logs
#   docker-compose down        # Parar
#
# Produção:
#   docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
# ==============================================================================

version: '3.8'

services:
  # ============================================================================
  # FAMLI - Aplicação Principal
  # ============================================================================
  famli:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        VERSION: ${VERSION:-dev}
        BUILD_TIME: ${BUILD_TIME:-}
    image: famli:${VERSION:-latest}
    container_name: famli
    
    # Portas
    ports:
      - "${PORT:-8080}:8080"
    
    # Variáveis de ambiente
    environment:
      - ENV=${ENV:-development}
      - PORT=8080
      - JWT_SECRET=${JWT_SECRET:-dev-secret-change-in-production}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY:-dev-key-change-in-production}
      - TWILIO_ACCOUNT_SID=${TWILIO_ACCOUNT_SID:-}
      - TWILIO_AUTH_TOKEN=${TWILIO_AUTH_TOKEN:-}
      - TWILIO_PHONE_NUMBER=${TWILIO_PHONE_NUMBER:-}
      - WEBHOOK_BASE_URL=${WEBHOOK_BASE_URL:-}
    
    # Volumes (para persistência futura)
    volumes:
      - famli_data:/app/data
    
    # Restart policy
    restart: unless-stopped
    
    # Limites de recursos
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M
    
    # Health check
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    
    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# ==============================================================================
# VOLUMES
# ==============================================================================
volumes:
  famli_data:
    driver: local

# ==============================================================================
# NETWORKS (para expansão futura com banco de dados, etc.)
# ==============================================================================
networks:
  default:
    name: famli_network

